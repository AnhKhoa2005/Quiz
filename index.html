<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trắc Nghiệm Động</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.47.0/docxtemplater.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.5/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f4;
            color: #333;
            line-height: 1.6;
        }
        .container {
            background-color: #fff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-width: 800px;
            margin: auto;
        }
        h1, h2 {
            color: #0056b3;
            text-align: center;
            margin-bottom: 20px;
        }
        textarea {
            width: 97%;
            height: 150px;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1em;
            resize: vertical;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
            margin-right: 10px;
            transition: background-color 0.2s;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .button-group {
            text-align: center;
            margin-bottom: 20px;
        }
        #quizContainer, #quizCompleteMessage, #manualInputSection, #rawInputSection, #answerSelectionSection, #reviewQuestionsSection, #examGenerationSection, #manualAnswersReviewSection {
            display: none;
            padding-top: 20px;
            border-top: 1px solid #eee;
            margin-top: 20px;
        }
        #question {
            font-weight: bold;
            margin-bottom: 15px;
            font-size: 1.1em;
        }
        #answerButtons button {
            display: block;
            width: 100%;
            text-align: left;
            margin-bottom: 8px;
            background-color: #f8f9fa;
            color: #333;
            border: 1px solid #ddd;
            padding: 12px;
            border-radius: 6px;
        }
        #answerButtons button.selected {
            background-color: #e0f7fa; /* Light blue for selected */
            border-color: #007bff;
        }
        #answerButtons button.correct {
            background-color: #d4edda; /* Light green for correct */
            border-color: #28a745;
        }
        #answerButtons button.incorrect {
            background-color: #f8d7da; /* Light red for incorrect */
            border-color: #dc3545;
        }
        #answerButtons button:hover:not(.correct):not(.incorrect) {
            background-color: #e9ecef;
        }
        #result {
            margin-top: 15px;
            font-weight: bold;
            text-align: center;
        }
        #timer {
            font-size: 1.2em;
            font-weight: bold;
            text-align: right;
            margin-bottom: 10px;
            color: #d9534f;
        }
        #currentQuestionIndicator {
            text-align: center;
            margin-bottom: 15px;
            font-size: 0.9em;
            color: #666;
        }
        #summaryTable {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        #summaryTable th, #summaryTable td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        #summaryTable th {
            background-color: #f2f2f2;
        }
        .incorrect-item {
            margin-bottom: 10px;
            border: 1px solid #f8d7da;
            background-color: #f8d7da50;
            padding: 10px;
            border-radius: 5px;
        }
        .incorrect-item p {
            margin: 5px 0;
        }
        .incorrect-item .correct-answer {
            color: #28a745;
            font-weight: bold;
        }
        .incorrect-item .your-answer {
            color: #dc3545;
            font-weight: bold;
        }
        .input-group {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
            gap: 10px;
        }
        .input-group label {
            font-weight: bold;
        }
        .input-group input[type="number"] {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 100px;
            text-align: center;
            font-size: 1em;
        }
        #examListButtons button {
            display: block;
            width: 100%;
            margin-bottom: 10px;
            background-color: #6c757d; /* Gray button for exam selection */
        }
        #examListButtons button:hover {
            background-color: #5a6268;
        }

        /* Styles for manual answers review */
        .manual-review-item {
            margin-bottom: 15px;
            padding: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        .manual-review-item p {
            margin: 5px 0;
        }
        .manual-review-item .question-text {
            font-weight: bold;
            color: #0056b3;
        }
        .manual-review-item .answer-item {
            margin-left: 15px;
            color: #555;
        }
        .manual-review-item .correct-answer-text {
            color: #28a745;
            font-weight: bold;
        }
        .suggestion {
            font-size: 0.9em;
            color: #666;
            margin-top: -10px;
            margin-bottom: 15px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Ứng Dụng Trắc Nghiệm</h1>

        <div id="mainInputSelection">
            <h2>Chọn Phương Thức Nhập Liệu</h2>
            <div class="button-group">
                <button onclick="showManualInput()">Nhập thủ công (đã định dạng)</button>
                <button onclick="showRawInput()">Nhập dữ liệu thô (chưa định dạng)</button>
                <button onclick="showExamGeneration()">Làm đề ngẫu nhiên</button>
            </div>
        </div>

        <div id="manualInputSection">
            <h2>Nhập Câu Hỏi Thủ Công</h2>
            <textarea id="manualQuestionsInput" placeholder="Nhập câu hỏi theo định dạng:&#10;Câu hỏi 1?&#10;- Đáp án A&#10;+ Đáp án B (đúng)&#10;- Đáp án C&#10;&#10;Câu hỏi 2?&#10;- Đáp án D&#10;+ Đáp án E&#10;- Đáp án F"></textarea>
            <div class="input-group">
                <label for="quizDurationManual">Thời gian làm bài (phút):</label>
                <input type="number" id="quizDurationManual" value="10" min="1">
            </div>
            <button onclick="startManualQuiz()">Bắt đầu Trắc Nghiệm</button>
            <button onclick="showManualAnswersReview()" style="background-color: #28a745;">Xem đáp án</button>
            <button onclick="backToMainSelection()">Quay lại</button>
        </div>

        <div id="manualAnswersReviewSection">
            <h2>Xem Đáp Án</h2>
            <div id="manualReviewQuestionsList"></div>
            <div class="button-group">
                <button onclick="startQuizFromManualReview()">Bắt đầu Trắc Nghiệm</button>
                <button onclick="backToManualInput()">Quay lại</button>
            </div>
        </div>

        <div id="rawInputSection">
            <h2>Nhập Dữ Liệu Thô</h2>
            <textarea id="rawQuestionsInput" placeholder="Dán nội dung từ file Word hoặc PDF. Hệ thống sẽ cố gắng phân tích."></textarea>
            <button onclick="parseAndShowReview()">Phân tích & Xem lại</button>
            <button onclick="backToMainSelection()">Quay lại</button>
        </div>

        <div id="answerSelectionSection">
            <h2>Chọn Câu Trả Lời Đúng</h2>
            <p>Vui lòng chọn đáp án đúng cho mỗi câu hỏi được phân tích.</p>
            <div id="parsedQuestionsReview"></div>
            <div class="input-group">
                <label for="quizDurationRaw">Thời gian làm bài (phút):</label>
                <input type="number" id="quizDurationRaw" value="10" min="1">
            </div>
            <button onclick="startQuizFromReview()">Bắt đầu Trắc Nghiệm</button>
            <button onclick="backToRawInput()">Quay lại</button>
        </div>

        <div id="reviewQuestionsSection">
            <h2>Xác nhận và Sửa đổi Câu hỏi</h2>
            <div id="editableQuestionsList"></div>
            <div class="input-group">
                <label for="quizDuration">Thời gian làm bài (phút):</label>
                <input type="number" id="quizDuration" value="10" min="1">
            </div>
            <button onclick="confirmQuestions()">Bắt đầu Trắc Nghiệm</button>
            <button onclick="exportQuestions()">Xuất Questions (Word)</button>
            <button onclick="backToRawInput()">Sửa lại phân tích</button>
        </div>

        <div id="examGenerationSection">
            <h2>Tạo Đề Trắc Nghiệm Ngẫu Nhiên</h2>
            <textarea id="examQuestionInput" placeholder="Nhập toàn bộ câu hỏi (đã định dạng + / -) cho ngân hàng đề." oninput="updateSuggestedNumExams()"></textarea>
            <div class="input-group">
                <label for="numExams">Số lượng đề muốn tạo:</label>
                <input type="number" id="numExams" value="1" min="1">
            </div>
            <div class="input-group">
                <label for="questionsPerExam">Số lượng câu hỏi mỗi đề:</label>
                <input type="number" id="questionsPerExam" value="10" min="1" oninput="updateSuggestedNumExams()">
            </div>
            <p class="suggestion">Có thể tạo tối đa <span id="suggestedNumExams">0</span> đề duy nhất từ ngân hàng hiện có.</p>
            <button onclick="generateExams()">Tạo Đề & Bắt đầu</button>
            <button onclick="backToMainSelection()">Quay lại</button>

            <div id="examSelectionArea" style="display: none; margin-top: 20px; border-top: 1px solid #eee; padding-top: 20px;">
                <h3>Chọn Đề Để Làm</h3>
                <div id="examListButtons"></div>
            </div>
        </div>

        <div id="quizContainer">
            <div id="timer"></div>
            <div id="currentQuestionIndicator"></div>
            <div id="question"></div>
            <div id="answerButtons"></div>
            <div id="result"></div>
            <button id="nextQuestionBtn" onclick="nextQuestion()">Câu tiếp theo</button>
        </div>

        <div id="quizCompleteMessage">
            <p>Chúc mừng! Bạn đã hoàn thành tất cả các câu hỏi.</p>
            <p id="finalScore"></p>
            <div id="incorrectAnswersList"></div>
            <button id="retakeWrongBtn" onclick="retakeWrongQuestions()" style="display: none;">Làm lại các câu sai</button>
            <button id="retakeAllBtn" onclick="retakeAllQuestions()" style="background-color: #17a2b8; display: none;">Làm lại toàn bộ đề</button>
            <button onclick="backToMainSelection()">Quay lại màn hình chính</button>
        </div>
    </div>

    <script>
        let questions = []; // Current set of questions for the quiz
        let originalQuestionsForRetake = []; // Stores the original set of questions for "Retake All"
        let currentQuestionIndex = 0;
        let score = 0;
        let shuffledQuestionIndices = []; // To keep track of shuffled order
        let timerInterval;
        let timeLeft;
        let totalQuizDurationSeconds;
        let incorrectlyAnsweredQuestions = [];
        let unansweredQuestions = [];
        let rawQuestions = []; // Store questions parsed from raw input before selection
        let allBankQuestions = []; // Ngân hàng câu hỏi gốc (parsed from exam input)
        let generatedExams = []; // Mảng chứa các đề thi đã tạo


        function showMainSelection() {
            console.log("Show Main Selection");
            document.getElementById('mainInputSelection').style.display = 'block';
            document.getElementById('manualInputSection').style.display = 'none';
            document.getElementById('rawInputSection').style.display = 'none';
            document.getElementById('answerSelectionSection').style.display = 'none';
            document.getElementById('reviewQuestionsSection').style.display = 'none';
            document.getElementById('quizContainer').style.display = 'none';
            document.getElementById('quizCompleteMessage').style.display = 'none';
            document.getElementById('examGenerationSection').style.display = 'none';
            document.getElementById('manualAnswersReviewSection').style.display = 'none'; // Ensure hidden
        }

        function showManualInput() {
            console.log("Show Manual Input");
            document.getElementById('mainInputSelection').style.display = 'none';
            document.getElementById('manualInputSection').style.display = 'block';
        }

        function showRawInput() {
            console.log("Show Raw Input");
            document.getElementById('mainInputSelection').style.display = 'none';
            document.getElementById('rawInputSection').style.display = 'block';
        }

        function backToMainSelection() {
            console.log("Back to Main Selection");
            showMainSelection();
            currentQuestionIndex = 0;
            shuffledQuestionIndices = [];
            questions = []; // Clear current questions
            originalQuestionsForRetake = []; // Clear original questions
            incorrectlyAnsweredQuestions = [];
            unansweredQuestions = [];
            rawQuestions = [];
            allBankQuestions = [];
            generatedExams = [];

            document.getElementById('quizContainer').style.display = 'none';
            document.getElementById('quizCompleteMessage').style.display = 'none';
            document.getElementById('retakeWrongBtn').style.display = 'none';
            document.getElementById('retakeAllBtn').style.display = 'none';
            document.getElementById('incorrectAnswersList').innerHTML = '';
            document.getElementById('examGenerationSection').style.display = 'none';
            document.getElementById('examQuestionInput').value = ''; // Clear input for exam generation
            document.getElementById('examSelectionArea').style.display = 'none'; // Hide exam selection
            document.getElementById('examListButtons').innerHTML = ''; // Clear exam buttons
            document.getElementById('manualQuestionsInput').value = ''; // Clear manual input
            stopTimer(); // Stop any running timer
        }

        function backToRawInput() {
            console.log("Back to Raw Input");
            document.getElementById('rawQuestionsInput').value = document.getElementById('rawQuestionsInput').dataset.originalValue || ''; // Restore original raw input
            document.getElementById('reviewQuestionsSection').style.display = 'none';
            document.getElementById('answerSelectionSection').style.display = 'none';
            document.getElementById('rawInputSection').style.display = 'block';
            document.getElementById('parsedQuestionsReview').innerHTML = ''; // Clear review
        }

        function backToManualInput() {
            console.log("Back to Manual Input");
            document.getElementById('manualAnswersReviewSection').style.display = 'none';
            document.getElementById('manualInputSection').style.display = 'block';
        }

        function parseQuestions(input) {
            const lines = input.split('\n').filter(line => line.trim() !== '');
            let parsed = [];
            let currentQuestion = null;
            let questionPattern = /^(?:Câu\s+\d+|[Qq]\.\d+|[0-9]+\.|\d+\.)\s*(.*)$/i;

            lines.forEach(line => {
                line = line.trim();

                let match = line.match(questionPattern);
                if (match) {
                    if (currentQuestion) {
                        if (currentQuestion.answers.length > 0 && currentQuestion.correctAnswer) {
                            parsed.push(currentQuestion);
                        } else {
                            console.warn('Skipping incomplete question:', currentQuestion.question);
                        }
                    }
                    currentQuestion = {
                        question: match[1].trim(),
                        answers: [],
                        correctAnswer: '' // Default to empty, will be set by user or '+' in manual input
                    };
                } else if (currentQuestion) {
                    let answerMatch = line.match(/^([A-Za-z]\.|\d+\.|\*|\-|\+|\([A-Za-z]\))\s*(.*)$/i);
                    if (answerMatch) {
                        let answerText = answerMatch[2].trim();
                        currentQuestion.answers.push(answerText);
                        // For manual input, check if it's the correct answer
                        if (line.startsWith('+')) {
                            if (currentQuestion.correctAnswer) {
                                console.warn(`Warning: Multiple correct answers for question "${currentQuestion.question}". Only the last one will be kept.`);
                            }
                            currentQuestion.correctAnswer = answerText;
                        }
                    } else if (line.length > 0) {
                        if (currentQuestion.answers.length > 0) {
                             currentQuestion.answers[currentQuestion.answers.length - 1] += ' ' + line;
                        } else {
                            currentQuestion.question += ' ' + line;
                        }
                    }
                }
            });

            if (currentQuestion && currentQuestion.answers.length > 0 && currentQuestion.correctAnswer) {
                parsed.push(currentQuestion);
            } else if (currentQuestion) {
                console.warn('Skipping final incomplete question:', currentQuestion.question);
            }
            return parsed;
        }

        function parseManualInputQuestions() {
            const input = document.getElementById('manualQuestionsInput').value;
            const lines = input.split('\n').filter(line => line.trim() !== '');
            let tempQuestions = [];
            let currentQuestion = null;

            let allValid = true;

            lines.forEach(line => {
                if (line.trim().length === 0) return;

                if (!line.startsWith('-') && !line.startsWith('+')) {
                    if (currentQuestion) {
                        if (currentQuestion.answers.length > 0 && currentQuestion.correctAnswer) {
                            tempQuestions.push(currentQuestion);
                        } else {
                            allValid = false;
                            alert(`Lỗi định dạng: Câu hỏi "${currentQuestion.question}" không hợp lệ (thiếu đáp án hoặc đáp án đúng). Vui lòng kiểm tra lại.`);
                            return; // Stop further processing for validation
                        }
                    }
                    currentQuestion = {
                        question: line.trim(),
                        answers: [],
                        correctAnswer: ''
                    };
                } else if (currentQuestion) {
                    const answerText = line.substring(1).trim();
                    const isCorrect = line.startsWith('+');
                    currentQuestion.answers.push(answerText);
                    if (isCorrect) {
                        if (currentQuestion.correctAnswer) {
                            allValid = false;
                            alert(`Lỗi định dạng: Câu hỏi "${currentQuestion.question}" có nhiều hơn một đáp án đúng. Vui lòng chỉ định một đáp án đúng bằng dấu '+'.`);
                            return; // Stop further processing for validation
                        }
                        currentQuestion.correctAnswer = answerText;
                    }
                }
            });

            if (currentQuestion && allValid) { // Add the last question if it exists and no prior errors
                if (currentQuestion.answers.length > 0 && currentQuestion.correctAnswer) {
                    tempQuestions.push(currentQuestion);
                } else {
                    allValid = false;
                    alert(`Lỗi định dạng: Câu hỏi "${currentQuestion.question}" không hợp lệ (thiếu đáp án hoặc đáp án đúng). Vui lòng kiểm tra lại.`);
                }
            }

            if (!allValid || tempQuestions.length === 0) {
                return null; // Return null if there are validation errors or no questions
            }
            return tempQuestions;
        }

        function startManualQuiz() {
            console.log("Starting Manual Quiz Directly...");
            const parsedQuestions = parseManualInputQuestions();

            if (!parsedQuestions) { // If parsing failed or returned null due to validation errors
                return;
            }

            questions = parsedQuestions;
            originalQuestionsForRetake = JSON.parse(JSON.stringify(questions));

            const durationInput = document.getElementById('quizDurationManual').value;
            const duration = parseInt(durationInput);
            if (isNaN(duration) || duration <= 0) {
                alert('Vui lòng nhập thời gian làm bài hợp lệ (phút).');
                return;
            }
            totalQuizDurationSeconds = duration * 60;
            timeLeft = totalQuizDurationSeconds;

            startQuizDisplay();
            shuffleQuestions();
            loadQuestion();
            startTimer();
        }

        function showManualAnswersReview() {
            console.log("Showing Manual Answers Review...");
            const parsedQuestions = parseManualInputQuestions();

            if (!parsedQuestions) { // If parsing failed or returned null due to validation errors
                return;
            }

            questions = parsedQuestions; // Set global questions for potential quiz start from here
            originalQuestionsForRetake = JSON.parse(JSON.stringify(questions)); // Store for retake all

            document.getElementById('manualInputSection').style.display = 'none';
            document.getElementById('manualAnswersReviewSection').style.display = 'block';

            const reviewList = document.getElementById('manualReviewQuestionsList');
            reviewList.innerHTML = '';

            questions.forEach((q, qIndex) => {
                const itemDiv = document.createElement('div');
                itemDiv.classList.add('manual-review-item');
                itemDiv.innerHTML = `<p class="question-text">Câu ${qIndex + 1}: ${q.question}</p>`;
                q.answers.forEach(ans => {
                    const answerP = document.createElement('p');
                    answerP.classList.add('answer-item');
                    if (ans === q.correctAnswer) {
                        answerP.classList.add('correct-answer-text');
                        answerP.textContent = `+ ${ans}`;
                    } else {
                        answerP.textContent = `- ${ans}`;
                    }
                    itemDiv.appendChild(answerP);
                });
                reviewList.appendChild(itemDiv);
            });
        }

        function startQuizFromManualReview() {
            console.log("Starting Quiz From Manual Review...");
            // Questions and originalQuestionsForRetake should already be set by showManualAnswersReview()
            if (questions.length === 0) {
                alert('Không có câu hỏi nào để bắt đầu trắc nghiệm.');
                return;
            }

            const durationInput = document.getElementById('quizDurationManual').value; // Use the duration from the manual input section
            const duration = parseInt(durationInput);
            if (isNaN(duration) || duration <= 0) {
                alert('Vui lòng nhập thời gian làm bài hợp lệ (phút).');
                return;
            }
            totalQuizDurationSeconds = duration * 60;
            timeLeft = totalQuizDurationSeconds;

            startQuizDisplay();
            shuffleQuestions();
            loadQuestion();
            startTimer();
        }

        function parseAndShowReview() {
            console.log("Parsing and Showing Review (Raw Input)...");
            const rawInput = document.getElementById('rawQuestionsInput').value;
            document.getElementById('rawQuestionsInput').dataset.originalValue = rawInput;

            rawQuestions = parseQuestions(rawInput); // Uses the general parseQuestions

            if (rawQuestions.length === 0) {
                alert('Không thể phân tích câu hỏi nào từ dữ liệu thô. Vui lòng kiểm tra định dạng.');
                return;
            }

            const reviewContainer = document.getElementById('editableQuestionsList');
            reviewContainer.innerHTML = '';

            rawQuestions.forEach((q, qIndex) => {
                const questionDiv = document.createElement('div');
                questionDiv.style.marginBottom = '20px';
                questionDiv.style.border = '1px solid #ddd';
                questionDiv.style.padding = '15px';
                questionDiv.style.borderRadius = '5px';
                questionDiv.innerHTML = `<p><strong>Câu ${qIndex + 1}: </strong><span contenteditable="true" data-field="question" data-index="${qIndex}">${q.question}</span></p>`;

                q.answers.forEach((ans, ansIndex) => {
                    const answerDiv = document.createElement('div');
                    answerDiv.style.marginBottom = '5px';
                    answerDiv.innerHTML = `
                        <input type="radio" name="correctAnswer_${qIndex}" id="correct_${qIndex}_${ansIndex}" value="${ans}" ${q.correctAnswer === ans ? 'checked' : ''}>
                        <label for="correct_${qIndex}_${ansIndex}"><span contenteditable="true" data-field="answer" data-q-index="${qIndex}" data-ans-index="${ansIndex}">${ans}</span></label>
                    `;
                    questionDiv.appendChild(answerDiv);
                });
                reviewContainer.appendChild(questionDiv);
            });

            document.getElementById('rawInputSection').style.display = 'none';
            document.getElementById('reviewQuestionsSection').style.display = 'block';
        }

        function confirmQuestions() {
            console.log("Confirming Questions...");
            questions = [];
            const reviewContainer = document.getElementById('editableQuestionsList');
            const questionDivs = reviewContainer.children;

            let allQuestionsValid = true;

            Array.from(questionDivs).forEach((qDiv, qIndex) => {
                const questionTextElement = qDiv.querySelector(`[data-field="question"][data-index="${qIndex}"]`);
                const questionText = questionTextElement ? questionTextElement.textContent.trim() : '';

                const radioButtons = qDiv.querySelectorAll(`input[name="correctAnswer_${qIndex}"]`);
                let selectedCorrectAnswer = null;
                radioButtons.forEach(radio => {
                    if (radio.checked) {
                        selectedCorrectAnswer = radio.value;
                    }
                });

                const answers = [];
                const answerLabels = qDiv.querySelectorAll(`label[data-field="answer"][data-q-index="${qIndex}"] span`);
                answerLabels.forEach(labelSpan => {
                    answers.push(labelSpan.textContent.trim());
                });

                if (questionText && answers.length > 0 && selectedCorrectAnswer) {
                    questions.push({
                        question: questionText,
                        answers: answers,
                        correctAnswer: selectedCorrectAnswer
                    });
                } else {
                    allQuestionsValid = false;
                    alert(`Câu hỏi ${qIndex + 1} không hợp lệ (thiếu câu hỏi, đáp án hoặc chưa chọn đáp án đúng). Vui lòng kiểm tra lại.`);
                }
            });

            if (!allQuestionsValid || questions.length === 0) {
                questions = [];
                return;
            }

            originalQuestionsForRetake = JSON.parse(JSON.stringify(questions));

            const durationInput = document.getElementById('quizDuration').value;
            const duration = parseInt(durationInput);
            if (isNaN(duration) || duration <= 0) {
                alert('Vui lòng nhập thời gian làm bài hợp lệ (phút).');
                return;
            }
            totalQuizDurationSeconds = duration * 60;
            timeLeft = totalQuizDurationSeconds;

            startQuizDisplay();
            shuffleQuestions();
            loadQuestion();
            startTimer();
        }

        function startQuizFromReview() {
            confirmQuestions();
        }

        function exportQuestions() {
            if (questions.length === 0) {
                alert('Không có câu hỏi nào để xuất.');
                return;
            }

            // Simple text export
            alert('Chức năng xuất Word yêu cầu một tệp mẫu .docx. Hiện tại chỉ hỗ trợ xuất dưới dạng văn bản thuần (text).');
            let textContent = "";
            questions.forEach((q, index) => {
                textContent += `Câu ${index + 1}: ${q.question}\n`;
                q.answers.forEach(ans => {
                    textContent += `${q.correctAnswer === ans ? '+' : '-'} ${ans}\n`;
                });
                textContent += "\n";
            });
            const blob = new Blob([textContent], { type: 'text/plain;charset=utf-8' });
            saveAs(blob, 'cau_hoi_trac_nghiem.txt');
        }


        function startQuizDisplay() {
            console.log("Starting Quiz Display...");
            document.getElementById('manualInputSection').style.display = 'none';
            document.getElementById('rawInputSection').style.display = 'none';
            document.getElementById('answerSelectionSection').style.display = 'none';
            document.getElementById('reviewQuestionsSection').style.display = 'none';
            document.getElementById('examGenerationSection').style.display = 'none';
            document.getElementById('manualAnswersReviewSection').style.display = 'none'; // Ensure hidden
            document.getElementById('quizContainer').style.display = 'block';
            document.getElementById('quizCompleteMessage').style.display = 'none';
            document.getElementById('nextQuestionBtn').style.display = 'block';
            document.getElementById('result').textContent = '';
        }

        function shuffleQuestions() {
            shuffledQuestionIndices = Array.from({ length: questions.length }, (_, i) => i);
            for (let i = shuffledQuestionIndices.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffledQuestionIndices[i], shuffledQuestionIndices[j]] = [shuffledQuestionIndices[j], shuffledQuestionIndices[i]];
            }
            currentQuestionIndex = 0;
        }

        function loadQuestion() {
            if (currentQuestionIndex >= shuffledQuestionIndices.length) {
                endQuiz();
                return;
            }

            const actualQuestionIndex = shuffledQuestionIndices[currentQuestionIndex];
            const currentQuestion = questions[actualQuestionIndex];

            document.getElementById('question').textContent = `Câu ${currentQuestionIndex + 1}: ${currentQuestion.question}`;
            document.getElementById('currentQuestionIndicator').textContent = `Câu ${currentQuestionIndex + 1} / ${questions.length}`;

            const answerButtonsDiv = document.getElementById('answerButtons');
            answerButtonsDiv.innerHTML = '';
            document.getElementById('result').textContent = '';
            document.getElementById('nextQuestionBtn').disabled = true;

            const shuffledAnswers = [...currentQuestion.answers];
            for (let i = shuffledAnswers.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffledAnswers[i], shuffledAnswers[j]] = [shuffledAnswers[j], shuffledAnswers[i]];
            }

            shuffledAnswers.forEach(answer => {
                const button = document.createElement('button');
                button.textContent = answer;
                button.onclick = () => selectAnswer(button, answer, currentQuestion);
                answerButtonsDiv.appendChild(button);
            });
        }

        function selectAnswer(selectedButton, selectedAnswer, currentQuestion) {
            const actualQuestionIndex = shuffledQuestionIndices[currentQuestionIndex];
            questions[actualQuestionIndex].yourAnswer = selectedAnswer;
            questions[actualQuestionIndex].attempted = true;

            const answerButtons = document.querySelectorAll('#answerButtons button');
            answerButtons.forEach(button => {
                button.disabled = true;
                button.classList.remove('selected');
                if (button === selectedButton) {
                    button.classList.add('selected');
                }
            });

            const resultDiv = document.getElementById('result');
            if (selectedAnswer === currentQuestion.correctAnswer) {
                resultDiv.textContent = 'Chính xác!';
                resultDiv.style.color = 'green';
                selectedButton.classList.add('correct');
                score++;
            } else {
                resultDiv.textContent = 'Sai rồi. Đáp án đúng là: ' + currentQuestion.correctAnswer;
                resultDiv.style.color = 'red';
                selectedButton.classList.add('incorrect');
                answerButtons.forEach(button => {
                    if (button.textContent === currentQuestion.correctAnswer) {
                        button.classList.add('correct');
                    }
                });
            }
            document.getElementById('nextQuestionBtn').disabled = false;
        }

        function nextQuestion() {
            currentQuestionIndex++;
            loadQuestion();
        }

        function startTimer() {
            clearInterval(timerInterval);
            const timerDisplay = document.getElementById('timer');
            timerDisplay.style.display = 'block';

            timerInterval = setInterval(() => {
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                timerDisplay.textContent = `Thời gian còn lại: ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    timerDisplay.textContent = 'Hết giờ!';
                    endQuiz(true);
                }
                timeLeft--;
            }, 1000);
        }

        function stopTimer() {
            clearInterval(timerInterval);
            document.getElementById('timer').style.display = 'none';
        }

        function endQuiz(timedOut = false) {
            stopTimer();

            document.getElementById('quizContainer').style.display = 'none';
            document.getElementById('result').textContent = '';
            document.getElementById('nextQuestionBtn').style.display = 'none';
            const quizCompleteMessage = document.getElementById('quizCompleteMessage');
            const finalScoreDisplay = document.getElementById('finalScore');
            const incorrectAnswersListDiv = document.getElementById('incorrectAnswersList');
            const retakeWrongBtn = document.getElementById('retakeWrongBtn');
            const retakeAllBtn = document.getElementById('retakeAllBtn');

            incorrectlyAnsweredQuestions = questions.filter(q => q.attempted && q.yourAnswer !== q.correctAnswer);
            unansweredQuestions = questions.filter(q => !q.attempted);

            let scoreMessage = `Bạn đã trả lời đúng ${score} trên ${questions.length} câu.`;
            if (timedOut) {
                scoreMessage += " (Hết giờ)";
            }
            finalScoreDisplay.textContent = scoreMessage;

            incorrectAnswersListDiv.innerHTML = '';
            if (incorrectlyAnsweredQuestions.length > 0) {
                const incorrectTitle = document.createElement('h3');
                incorrectTitle.textContent = 'Các câu trả lời sai:';
                incorrectAnswersListDiv.appendChild(incorrectTitle);
                incorrectlyAnsweredQuestions.forEach((q, index) => {
                    const item = document.createElement('div');
                    item.classList.add('incorrect-item');
                    item.innerHTML = `
                        <p><strong>Câu hỏi:</strong> ${q.question}</p>
                        <p class="your-answer"><strong>Câu trả lời của bạn:</strong> ${q.yourAnswer || 'Chưa trả lời'}</p>
                        <p class="correct-answer"><strong>Đáp án đúng:</strong> ${q.correctAnswer}</p>
                    `;
                    incorrectAnswersListDiv.appendChild(item);
                });
                retakeWrongBtn.textContent = 'Làm lại các câu sai';
                retakeWrongBtn.style.display = 'block';
            }

            if (unansweredQuestions.length > 0) {
                const unansweredTitle = document.createElement('h3');
                unansweredTitle.textContent = 'Các câu chưa trả lời:';
                incorrectAnswersListDiv.appendChild(unansweredTitle);
                if (incorrectlyAnsweredQuestions.length > 0) {
                    retakeWrongBtn.textContent = 'Làm lại các câu sai hoặc chưa làm';
                } else {
                    retakeWrongBtn.textContent = 'Làm lại các câu chưa làm';
                }
                unansweredQuestions.forEach((q, index) => {
                    const item = document.createElement('div');
                    item.classList.add('incorrect-item');
                    item.innerHTML = `
                        <p><strong>Câu hỏi:</strong> ${q.question}</p>
                        <p>Bạn chưa trả lời câu này.</p>
                        <p class="correct-answer"><strong>Đáp án đúng:</strong> ${q.correctAnswer}</p>
                    `;
                    incorrectAnswersListDiv.appendChild(item);
                });
                retakeWrongBtn.style.display = 'block';
            }

            retakeAllBtn.style.display = 'block';

            quizCompleteMessage.style.display = 'block';

            const allAnswerButtons = document.querySelectorAll('#answerButtons button');
            allAnswerButtons.forEach(button => button.disabled = true);
        }

        function retakeWrongQuestions() {
            const questionsToRetake = [...incorrectlyAnsweredQuestions, ...unansweredQuestions];

            if (questionsToRetake.length === 0) {
                alert('Không có câu hỏi sai hoặc chưa làm để làm lại!');
                return;
            }

            questions = questionsToRetake.map(q => ({...q, attempted: false, yourAnswer: undefined}));
            incorrectlyAnsweredQuestions = [];
            unansweredQuestions = [];
            score = 0;

            document.getElementById('quizCompleteMessage').style.display = 'none';
            document.getElementById('incorrectAnswersList').innerHTML = '';
            document.getElementById('retakeWrongBtn').style.display = 'none';
            document.getElementById('retakeAllBtn').style.display = 'none';

            shuffleQuestions();
            loadQuestion();
            const durationInput = document.getElementById('quizDuration').value || document.getElementById('quizDurationManual').value || '10';
            const duration = parseInt(durationInput);
            totalQuizDurationSeconds = duration * 60;
            timeLeft = totalQuizDurationSeconds;
            startTimer();
        }

        function retakeAllQuestions() {
            if (originalQuestionsForRetake.length === 0) {
                alert('Không có đề nào để làm lại. Vui lòng bắt đầu một bài trắc nghiệm mới.');
                return;
            }
            questions = JSON.parse(JSON.stringify(originalQuestionsForRetake));
            incorrectlyAnsweredQuestions = [];
            unansweredQuestions = [];
            score = 0;

            document.getElementById('quizCompleteMessage').style.display = 'none';
            document.getElementById('incorrectAnswersList').innerHTML = '';
            document.getElementById('retakeWrongBtn').style.display = 'none';
            document.getElementById('retakeAllBtn').style.display = 'none';

            shuffleQuestions();
            loadQuestion();

            const durationInput = document.getElementById('quizDuration').value || document.getElementById('quizDurationManual').value || '10';
            const duration = parseInt(durationInput);
            totalQuizDurationSeconds = duration * 60;
            timeLeft = totalQuizDurationSeconds;
            startTimer();
        }

        // --- Exam Generation Functions ---
        function showExamGeneration() {
            console.log("Showing Exam Generation Section...");
            document.getElementById('mainInputSelection').style.display = 'none';
            document.getElementById('manualInputSection').style.display = 'none';
            document.getElementById('rawInputSection').style.display = 'none';
            document.getElementById('answerSelectionSection').style.display = 'none';
            document.getElementById('reviewQuestionsSection').style.display = 'none';
            document.getElementById('quizContainer').style.display = 'none';
            document.getElementById('quizCompleteMessage').style.display = 'none';
            document.getElementById('manualAnswersReviewSection').style.display = 'none'; // Ensure hidden

            document.getElementById('examGenerationSection').style.display = 'block';
            document.getElementById('examQuestionInput').value = '';
            document.getElementById('examSelectionArea').style.display = 'none';
            document.getElementById('examListButtons').innerHTML = '';

            allBankQuestions = [];
            generatedExams = [];
            updateSuggestedNumExams(); // Update suggestion when section is shown
        }

        function parseExamBankQuestions() {
            const input = document.getElementById('examQuestionInput').value;
            const lines = input.split('\n').filter(line => line.trim() !== '');
            let tempQuestions = [];
            let currentQuestion = null;

            lines.forEach(line => {
                if (line.trim().length === 0) return;

                if (!line.startsWith('-') && !line.startsWith('+')) {
                    if (currentQuestion) {
                        if (currentQuestion.answers.length > 0 && currentQuestion.correctAnswer) {
                            tempQuestions.push(currentQuestion);
                        } else {
                            console.warn('Bỏ qua câu hỏi không hợp lệ (thiếu đáp án hoặc đáp án đúng):', currentQuestion.question);
                        }
                    }
                    currentQuestion = {
                        question: line.trim(),
                        answers: [],
                        correctAnswer: ''
                    };
                } else if (currentQuestion) {
                    const answerText = line.substring(1).trim();
                    const isCorrect = line.startsWith('+');
                    currentQuestion.answers.push(answerText);
                    if (isCorrect) {
                        if (currentQuestion.correctAnswer) {
                            console.warn(`Câu hỏi "${currentQuestion.question}" có nhiều hơn một đáp án đúng trong ngân hàng đề.`);
                        }
                        currentQuestion.correctAnswer = answerText;
                    }
                }
            });

            if (currentQuestion && currentQuestion.answers.length > 0 && currentQuestion.correctAnswer) {
                tempQuestions.push(currentQuestion);
            } else if (currentQuestion) {
                console.warn('Bỏ qua câu hỏi cuối cùng không hợp lệ (thiếu đáp án hoặc đáp án đúng):', currentQuestion.question);
            }
            return tempQuestions;
        }

        function updateSuggestedNumExams() {
            const currentBank = parseExamBankQuestions();
            const questionsPerExam = parseInt(document.getElementById('questionsPerExam').value);
            const suggestedNumExamsSpan = document.getElementById('suggestedNumExams');

            if (isNaN(questionsPerExam) || questionsPerExam <= 0) {
                suggestedNumExamsSpan.innerHTML = 'Vui lòng nhập số câu hỏi mỗi đề hợp lệ.';
                return;
            }

            const totalQuestionsInBank = currentBank.length;
            const maxFullUniqueExams = Math.floor(totalQuestionsInBank / questionsPerExam);
            const remainingQuestions = totalQuestionsInBank % questionsPerExam;

            let suggestionText = `Có thể tạo tối đa <strong>${maxFullUniqueExams}</strong> đề duy nhất từ ngân hàng hiện có.`;

            if (totalQuestionsInBank === 0) {
                suggestionText = `Ngân hàng đề trống.`;
            } else if (maxFullUniqueExams === 0 && totalQuestionsInBank < questionsPerExam) {
                // Case: Bank has questions, but not enough for even one full unique exam
                suggestionText += ` (Ngân hàng có ${totalQuestionsInBank} câu hỏi. Để có 1 đề ${questionsPerExam} câu, sẽ cần bù đắp ${questionsPerExam - totalQuestionsInBank} câu ngẫu nhiên từ ngân hàng, có thể trùng lặp).`;
            } else if (remainingQuestions > 0) {
                // At least one full unique exam possible, and there are remainders
                suggestionText += ` Bạn có thể tạo thêm <strong>1</strong> đề nữa (đề này sẽ bao gồm ${remainingQuestions} câu hỏi duy nhất còn lại và được bù đắp bằng ${questionsPerExam - remainingQuestions} câu ngẫu nhiên từ ngân hàng, có thể trùng lặp).`;
            }

            suggestedNumExamsSpan.innerHTML = suggestionText; // Use innerHTML for strong tag
        }


        function generateExams() {
            console.log("Generating Exams...");
            allBankQuestions = parseExamBankQuestions();

            if (allBankQuestions.length === 0) {
                alert('Vui lòng nhập câu hỏi vào ngân hàng đề.');
                return;
            }

            const numExams = parseInt(document.getElementById('numExams').value);
            const questionsPerExam = parseInt(document.getElementById('questionsPerExam').value);

            if (isNaN(numExams) || numExams <= 0) {
                alert('Lỗi: Số lượng đề không hợp lệ. Vui lòng nhập một số dương.');
                return;
            }
            if (isNaN(questionsPerExam) || questionsPerExam <= 0) {
                alert('Lỗi: Số lượng câu hỏi mỗi đề không hợp lệ. Vui lòng nhập một số dương.');
                return;
            }

            const totalQuestionsInBank = allBankQuestions.length;
            const maxFullUniqueExams = Math.floor(totalQuestionsInBank / questionsPerExam);
            const remainingUniqueQuestionsCount = totalQuestionsInBank % questionsPerExam;

            // Strict validation for 'numExams' beyond the allowed limit
            // Block if requested exams are more than maxFullUniqueExams + 1
            // Or if numExams is maxFullUniqueExams + 1 but there are no remaining unique questions (meaning the +1 exam would be entirely repeated)
            if (numExams > maxFullUniqueExams + 1 || (numExams === maxFullUniqueExams + 1 && remainingUniqueQuestionsCount === 0)) {
                let errorMessage = `Không thể tạo ${numExams} đề với ${questionsPerExam} câu hỏi mỗi đề.\n`;
                errorMessage += `Ngân hàng đề chỉ có ${totalQuestionsInBank} câu hỏi duy nhất. \n`;

                if (maxFullUniqueExams > 0) {
                    errorMessage += `Bạn chỉ có thể tạo tối đa ${maxFullUniqueExams} đề duy nhất. `;
                    if (remainingUniqueQuestionsCount > 0) {
                        errorMessage += `Hoặc thêm 1 đề thứ ${maxFullUniqueExams + 1} (có thể bao gồm câu hỏi trùng lặp để đủ số lượng).`;
                    }
                } else { // maxFullUniqueExams === 0
                    if (totalQuestionsInBank > 0) { // Has some questions, but not enough for a full unique exam
                         errorMessage += `Để tạo 1 đề ${questionsPerExam} câu, bạn cần ít nhất ${questionsPerExam} câu hỏi. Ngân hàng chỉ có ${totalQuestionsInBank} câu. Bạn có thể tạo 1 đề duy nhất (sẽ được bù đắp câu hỏi).`;
                    } else { // No questions at all
                         errorMessage += `Ngân hàng đề không có câu hỏi nào.`;
                    }
                }
                errorMessage += `\nVui lòng điều chỉnh lại "Số lượng đề muốn tạo" hoặc "Số lượng câu hỏi mỗi đề".`;
                alert(errorMessage);
                return;
            }

            generatedExams = [];
            let currentUniquePool = [...allBankQuestions]; // Pool for unique questions for all exams

            for (let i = 0; i < numExams; i++) {
                const examQuestions = [];
                // Prioritize unique questions from the current pool
                currentUniquePool.sort(() => Math.random() - 0.5); // Shuffle the unique pool

                const numToTakeFromUniquePool = Math.min(questionsPerExam, currentUniquePool.length);
                for (let j = 0; j < numToTakeFromUniquePool; j++) {
                    examQuestions.push(currentUniquePool.shift()); // Take and remove from unique pool
                }

                // If this is the "extra" exam (i.e., numExams > maxFullUniqueExams),
                // and it still needs more questions, fill with random questions from the *entire original bank*
                // This ensures the last exam is filled, allowing repetition.
                if (examQuestions.length < questionsPerExam && i === maxFullUniqueExams) {
                    const questionsToFill = questionsPerExam - examQuestions.length;
                    const shuffledAllBankQuestions = [...allBankQuestions].sort(() => Math.random() - 0.5); // Shuffle entire bank for repetition

                    for (let k = 0; k < questionsToFill; k++) {
                        // Add questions from the entire bank, allowing repetition
                        examQuestions.push(shuffledAllBankQuestions[Math.floor(Math.random() * shuffledAllBankQuestions.length)]);
                    }
                }
                // Important: If numExams is less than maxFullUniqueExams,
                // the loop just stops and takes the first 'numExams' generated, which are unique.

                generatedExams.push(examQuestions);
            }
            // No need to slice generatedExams, as the loop runs exactly `numExams` times.

            displayExamButtons();
            document.getElementById('examSelectionArea').style.display = 'block';
        }

        function displayExamButtons() {
            const examListButtonsDiv = document.getElementById('examListButtons');
            examListButtonsDiv.innerHTML = '';

            generatedExams.forEach((exam, index) => {
                const button = document.createElement('button');
                button.textContent = `Làm Đề ${index + 1} (${exam.length} câu)`;
                button.onclick = () => startExam(index);
                examListButtonsDiv.appendChild(button);
            });
        }

        function startExam(examIndex) {
            console.log(`Starting Exam ${examIndex + 1}...`);
            questions = generatedExams[examIndex];
            originalQuestionsForRetake = JSON.parse(JSON.stringify(questions));

            currentQuestionIndex = 0;
            score = 0;
            incorrectlyAnsweredQuestions = [];
            unansweredQuestions = [];
            questions.forEach(q => {
                q.attempted = false;
                q.yourAnswer = undefined;
            });
            shuffledQuestionIndices = [];

            const durationInput = document.getElementById('quizDuration').value || '10';
            const duration = parseInt(durationInput);
            totalQuizDurationSeconds = duration * 60;
            timeLeft = totalQuizDurationSeconds;

            startQuizDisplay();
            shuffleQuestions();
            loadQuestion();
            startTimer();
        }

        document.addEventListener('DOMContentLoaded', showMainSelection);
    </script>
</body>
</html>